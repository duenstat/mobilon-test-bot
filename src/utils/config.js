import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config({ path: path.join(__dirname, '../../.env') });

/**
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */
const config = {
    // –ë–∏—Ç—Ä–∏–∫—Å24
    bitrix: {
        url: process.env.BITRIX_URL,
        userId: parseInt(process.env.BITRIX_USER_ID) || 1,
        secret: process.env.BITRIX_WEBHOOK_SECRET,
        botId: process.env.BOT_ID
    },

    // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    schedule: {
        morningGreeting: {
            hour: parseInt(process.env.GREETING_HOUR) || 9,
            minute: parseInt(process.env.GREETING_MINUTE) || 0,
            // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1-5 - –ø–Ω-–ø—Ç, 6 - —Å—É–±–±–æ—Ç–∞)
            daysOfWeek: process.env.GREETING_DAYS 
                ? process.env.GREETING_DAYS.split(',').map(d => parseInt(d.trim()))
                : [1, 2, 3, 4, 5], // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–Ω-–ø—Ç
            timezone: process.env.TIMEZONE || 'Europe/Moscow'
        }
    },

    // –°–æ–æ–±—â–µ–Ω–∏—è
    messages: {
        greetings: [
            'üåû –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {name}! –ñ–µ–ª–∞—é –≤–∞–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–Ω—è!',
            '‚òÄÔ∏è –ü—Ä–∏–≤–µ—Ç, {name}! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å–µ—Ç —Ç–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–µ–µ!',
            'üåÖ –° –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º, {name}! –û—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —É—Å–ø–µ—Ö–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ!',
            'üí´ –î–æ–±—Ä—ã–π –¥–µ–Ω—å, {name}! –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–Ω—å —Å –ø–æ–∑–∏—Ç–∏–≤–∞!',
            'üåà –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {name}! –ü—É—Å—Ç—å –¥–µ–Ω—å –±—É–¥–µ—Ç —è—Ä–∫–∏–º –∏ —É—Å–ø–µ—à–Ω—ã–º!',
            'üå∏ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {name}! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è –∏ –æ—Ç–ª–∏—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!',
            '‚≠ê –ü—Ä–∏–≤–µ—Ç, {name}! –ù–æ–≤—ã–π –¥–µ–Ω—å - –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!',
            'üéØ –° –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º, {name}! –ü—É—Å—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞—é—Ç—Å—è –ª–µ–≥–∫–æ!',
            'üöÄ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {name}! –≠–Ω–µ—Ä–≥–∏–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å!',
            '‚òï –ü—Ä–∏–≤–µ—Ç, {name}! –ù–∞—á–Ω—ë–º –¥–µ–Ω—å —Å —É–ª—ã–±–∫–∏ –∏ —á–∞—à–∫–∏ –∫–æ—Ñ–µ!'
        ],
        tips: [
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å —Å–∞–º–æ–π –≤–∞–∂–Ω–æ–π –∑–∞–¥–∞—á–∏ - —ç—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –≤–∞—à—É –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏.',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–∑ 3 –≥–ª–∞–≤–Ω—ã—Ö —Ü–µ–ª–µ–π –Ω–∞ –¥–µ–Ω—å - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è.',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–í—ã–ø–µ–π—Ç–µ —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –≤–∞–∂–Ω–∞ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–£–¥–µ–ª–∏—Ç–µ 5 –º–∏–Ω—É—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –¥–Ω—è - —ç—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã.',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–ü–æ–º–Ω–∏—Ç–µ –æ –ø—Ä–∞–≤–∏–ª–µ 2 –º–∏–Ω—É—Ç: –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ–Ω—å—à–µ 2 –º–∏–Ω—É—Ç - —Å–¥–µ–ª–∞–π—Ç–µ –µ—ë —Å—Ä–∞–∑—É!',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É Pomodoro: 25 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã, 5 –º–∏–Ω—É—Ç –æ—Ç–¥—ã—Ö–∞.',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ - —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –ª–∞–¥.',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–û—Ç–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è –≤–∞–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã - —Ñ–æ–∫—É—Å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ!',
            '[b]üí° –°–æ–≤–µ—Ç –¥–Ω—è:[/b]\n–°–¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–æ–≤ - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è.'
        ],
        holidays: {
            '01-01': 'üéÑ –° –ù–æ–≤—ã–º –≥–æ–¥–æ–º, {name}! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –≥–æ–¥ –±—É–¥–µ—Ç –ø–æ–ª–æ–Ω —É—Å–ø–µ—Ö–æ–≤!',
            '23-02': 'üéñÔ∏è –° –î–Ω—ë–º –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞, {name}!',
            '08-03': 'üå∑ –° –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º –∂–µ–Ω—Å–∫–∏–º –¥–Ω—ë–º, {name}!',
            '01-05': 'üå∫ –° –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º –í–µ—Å–Ω—ã –∏ –¢—Ä—É–¥–∞, {name}!',
            '09-05': 'üéóÔ∏è –° –î–Ω—ë–º –ü–æ–±–µ–¥—ã, {name}!',
            '12-06': 'üá∑üá∫ –° –î–Ω—ë–º –†–æ—Å—Å–∏–∏, {name}!',
            '04-11': 'ü§ù –° –î–Ω—ë–º –Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–∞, {name}!'
        }
    },

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
    bot: {
        maxUsersPerBatch: parseInt(process.env.MAX_USERS_PER_BATCH) || 10,
        delayBetweenMessages: parseInt(process.env.MESSAGE_DELAY) || 1000, // –º—Å
        retryAttempts: parseInt(process.env.RETRY_ATTEMPTS) || 3,
        retryDelay: parseInt(process.env.RETRY_DELAY) || 5000 // –º—Å
    },

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
    server: {
        port: parseInt(process.env.PORT) || 3000,
        host: process.env.HOST || 'localhost'
    },

    // –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    isDevelopment: process.env.NODE_ENV === 'development',
    isProduction: process.env.NODE_ENV === 'production',
    logLevel: process.env.LOG_LEVEL || 'info'
};

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
export function validateConfig() {
    const errors = [];

    if (!config.bitrix.url) {
        errors.push('BITRIX_URL –Ω–µ —É–∫–∞–∑–∞–Ω –≤ .env');
    }

    if (!config.bitrix.secret) {
        errors.push('BITRIX_WEBHOOK_SECRET –Ω–µ —É–∫–∞–∑–∞–Ω –≤ .env');
    }

    if (errors.length > 0) {
        throw new Error(`–û—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:\n${errors.join('\n')}`);
    }

    return true;
}

export default config;
